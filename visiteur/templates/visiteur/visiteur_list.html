{% extends 'template_base.html' %}

{% block contenue %}

<div class="container-fluid mt-5">
  <h2 class="text-center mb-4 text-white">Liste des Visiteurs</h2>

  <!-- Formulaire principal -->
  <form id="visiteur-form" method="POST" action="{% url 'visiteur:generate_word' %}">
    {% csrf_token %}
    <input type="hidden" id="csrf-token" value="{{ csrf_token }}">

    <!-- Boutons et recherche -->
    <div class="row mb-4">
      <div class="col-md-6 d-flex gap-2 flex-wrap">
        <a href="{% url 'visiteur:visiteur_create' %}" class="btn btn-marine">
          <i class="bi bi-person-plus"></i> Créer un nouveau visiteur
        </a>
        <a href="{% url 'visiteur:visiteur_impression' %}" class="btn btn-secondary">
          <i class="bi bi-printer"></i> Imprimer
        </a>
        <button type="submit" class="btn btn-primary">
          Traiter la sélection
        </button>
      </div>

      <!-- Recherche par lien -->
      <div class="col-md-6 d-flex justify-content-end gap-2 mt-2 mt-md-0">
        <input type="text" id="search-input" class="form-control search-input" placeholder="Rechercher par nom, prénom, sexe, téléphone..." value="{{ query }}">
        <a href="#" id="search-link" class="btn btn-marine">Rechercher</a>
      </div>
    </div>

    <!-- Tableau -->
    <div class="table-responsive" id="visitors-table">
      <table class="table table-hover table-bordered text-center bg-white">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Nom</th>
            <th>Prénom</th>
            <th>Sexe</th>
            <th>Téléphone</th>
            <th>Email</th>
            <th>Date naissance</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for visiteur in visiteurs %}
          <tr>
            <td>
              <input type="checkbox" name="visiteur_select_checkbox" value="{{ visiteur.id }}" class="visiteur-checkbox">
            </td>
            <td>{{ visiteur.tnm }}</td>
            <td>{{ visiteur.tpm }}</td>
            <td>{{ visiteur.tsx }}</td>
            <td>{{ visiteur.tphne }}</td>
            <td>{{ visiteur.teml }}</td>
            <td>{{ visiteur.dns }}</td>
            <td>{{ visiteur.tstt }}</td>
            <td>
              <a href="{% url 'visiteur:visiteur_detail' visiteur.id %}" class="btn btn-info btn-sm mb-1">
                <i class="bi bi-eye"></i> Détails
              </a>
              <a href="{% url 'visiteur:visiteur_update' visiteur.id %}" class="btn btn-warning btn-sm mb-1">
                <i class="bi bi-pencil-square"></i> Modifier
              </a>
              <a href="{% url 'connection:detail' visiteur.id %}" class="btn btn-secondary btn-sm">
                <i class="bi bi-person-vcard"></i> Compte
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" class="text-muted">Aucun visiteur trouvé.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
</div>

<!-- JS -->
<script>
  // Recherche via lien
  document.getElementById('search-link').addEventListener('click', function (e) {
    e.preventDefault();
    const query = document.getElementById('search-input').value.trim();
    let url = "{% url 'visiteur:visiteur_search' %}";
    if (query) {
      url += "?q=" + encodeURIComponent(query);
    }
    window.location.href = url;
  });

  // Validation sélection avant soumission
  document.getElementById('visiteur-form').addEventListener('submit', function (e) {
    const form = this;
    const selected = document.querySelectorAll('.visiteur-checkbox:checked');

    if (selected.length === 0) {
      e.preventDefault();
      alert("Veuillez sélectionner au moins un visiteur.");
      return;
    }

    // Nettoyage champs cachés précédents
    form.querySelectorAll('input[type="hidden"][name="visiteur_select[]"]').forEach(el => el.remove());

    // Ajout de nouveaux champs cachés
    selected.forEach(cb => {
      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden';
      hiddenInput.name = 'visiteur_select[]';
      hiddenInput.value = cb.value;
      form.appendChild(hiddenInput);
    });
  });
</script>

{% endblock %}
