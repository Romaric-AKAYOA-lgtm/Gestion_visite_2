{% extends 'template_base.html' %}

{% block contenue %}
<style>
    .btn-marine {
        background-color: #003366;
        border-color: #003366;
        color: white;
    }

    .btn-marine:hover {
        background-color: #002244;
        border-color: #002244;
        color: white;
    }

    .search-input {
        max-width: 300px;
    }

    .visite-checkbox {
        width: 20px;
        height: 20px;
    }
</style>

<div class="container-fluid mt-5">
    <h2 class="text-center mb-4 text-white">Liste des Visites</h2>

    <!-- Formulaire principal pour traitement Word -->
    <form id="visite-form" method="POST" action="{% url 'visite:generate_word' %}">
        {% csrf_token %}

        <!-- Ligne responsive pour les boutons et la recherche -->
        <div class="row align-items-center mb-4 gy-2">
            <!-- Colonne gauche : Boutons -->
            <div class="col-md-8 d-flex flex-wrap gap-2">
                <a href="{% url 'visite:visite_create' %}" class="btn btn-marine">
                    <i class="bi bi-person-plus"></i> Nouvelle Visite
                </a>
                <a href="{% url 'visite:visite_impression' %}" class="btn btn-secondary">
                    <i class="bi bi-printer"></i> Imprimer
                </a>
                <button type="submit" class="btn btn-primary" id="generate-word">
                    Traiter la sélection
                </button>
            </div>

            <!-- Colonne droite : champ de recherche -->
            <div class="col-md-4 d-flex justify-content-md-end gap-2">
                <input type="text" name="q" class="form-control search-input" placeholder="Rechercher..." value="{{ query }}" form="search-form">
                <button type="submit" class="btn btn-marine" form="search-form">Rechercher</button>
            </div>
        </div>

        <!-- Tableau des visites -->
        <div class="table-responsive">
            <table class="table table-hover text-center bg-white">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Nom</th>
                        <th>Prénom</th>
                        <th>Sexe</th>
                        <th>Statut visiteur</th>
                        <th>Téléphone</th>
                        <th>Objet</th>
                        <th>Description</th>
                        <th>Date</th>
                        <th>Heure</th>
                        <th>Statut</th>
                        <th>Visitée</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for visite in visites %}
                        <tr>
                            <td>
                                <input type="checkbox" name="visite_select[]" value="{{ visite.id }}" class="visite-checkbox">
                            </td>
                            <td>{{ visite.idvstr.tnm }}</td>
                            <td>{{ visite.idvstr.tpm }}</td>
                            <td>{{ visite.idvstr.tsx }}</td>
                            <td>{{ visite.idvstr.ttvst }}</td>
                            <td>
                                <a href="https://web.whatsapp.com/send?phone={{ visite.idvstr.tphne }}" target="_blank">
                                    {{ visite.idvstr.tphne }}
                                </a>
                            </td>
                            <td>{{ visite.tobjt }}</td>
                            <td>{{ visite.ttvst }}</td>
                            <td>{{ visite.ddvst|date:"Y-m-d" }}</td>
                            <td>{{ visite.hvst|time:"H:i" }}</td>
                            <td>{{ visite.tsttvst }}</td>
                            <td>
                                {{ visite.iddirecteur.tnm }} {{ visite.iddirecteur.tpm }}<br>
                                <a href="https://web.whatsapp.com/send?phone={{ visite.iddirecteur.tphne }}" target="_blank">
                                    {{ visite.iddirecteur.tphne }}
                                </a>
                            </td>
                            <td>
                                <a href="{% url 'visite:visite_detail' visite.id %}" class="btn btn-info btn-sm mb-1">
                                    <i class="bi bi-eye"></i> Détails
                                </a>
                                <a href="{% url 'visite:visite_update' visite.id %}" class="btn btn-warning btn-sm">
                                    <i class="bi bi-pencil-square"></i> Modifier
                                </a>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="13" class="text-muted">Aucune visite trouvée.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>

    <!-- Formulaire séparé pour la recherche (hors du <form> principal) -->
    <form id="search-form" method="GET" action="{% url 'visite:visite_search' %}"></form>
</div>

<!-- Script de validation -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('visite-form');
        const checkboxes = document.querySelectorAll('.visite-checkbox');
        const generateBtn = document.getElementById('generate-word');

        function updateButtonState() {
            const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
            generateBtn.disabled = !anyChecked;
        }

        checkboxes.forEach(cb => cb.addEventListener('change', updateButtonState));
        updateButtonState();

        form.addEventListener('submit', function (e) {
            const selected = document.querySelectorAll('.visite-checkbox:checked');
            if (selected.length === 0) {
                e.preventDefault();
                alert("Veuillez sélectionner au moins une visite.");
            }
        });
    });
</script>
{% endblock %}
